{% extends 'PROCERGSVPRCoreBundle::base.html.twig' %}

{% block body %}
<div class="row">
    <div class="col-md-12">
        <h1>{% trans %}Duplicate Vote Detected{% endtrans %}</h1>
        <div class="alert alert-danger">{% trans %}It was detected that a vote were already cast by you.{% endtrans %}</div>
    </div>

    <div class="col-md-12 general-content">
        <p>{% trans %}If you believe that's a mistake, you can still vote using your citizen login on Meu RS enabled with a Nota Fiscal Gaúcha account to override this vote.{% endtrans %}</p>
        {% if app.user.getLoginCidadaoId %}
            <p><button class="btn btn-success" onclick="go()">{{ 'Enter Meu RS'|trans }}</button></p>
        {% else %}
          {% for owner in hwi_oauth_resource_owners() %}
          <p><a class="btn btn-success" role="button" href="{{ hwi_oauth_login_url(owner) }}">{{ 'Enter Meu RS'|trans }}</a></p>
          {% endfor %}
        {% endif %}

        <p><a id="btn-skip" class="btn btn-success" role="button" href="{{ path('fos_user_security_logout') }}">{{ 'Skip Step' | trans }}</a></p>
    </div>

    <div class="modal fade" id="lc-listener" tabindex="-1" role="dialog" aria-labelledby="lc-listener" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                  <h4 class="modal-title" >{{ 'Aguardando atendimento dos requisitos'|trans }}</h4>
                  <p>Acesse <a href="{{ link_lc }}" target="_blank">aqui o Meu RS</a></p>
              </div>
              <div class="modal-body">
              <ul class="lc-req">
                <li id="req_full_name"><span class="glyphicon"></span>login cidadao com nome cadastrado</li>
                <li id="req_email"><span class="glyphicon"></span>login cidadao com e-mail confirmado</li>
                <li id="req_nfg_access_lvl"><span class="glyphicon"></span>login cidadao com NFG vinculada</li>
                <li id="req_voter_registration"><span class="glyphicon"></span>login cidadao com titulo de eleitor validado pela NFG</li>
                <li id="req_tre_valid"><span class="glyphicon"></span>O nome e o titulo devem ser válidos pelos Tre</li>
              </ul>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-primary" data-dismiss="modal">{{ 'Skip Step'|trans }}</button>
              </div>
          </div>
      </div>
    </div>

</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}

<script>
var userModel = {{ checklist|json_encode|raw }};
var onSuccess = '{{ path('procergsvpr_core_homepage') }}';

var userAction = {};
userAction.user = userModel;

userAction.conn = null;
userAction.poll = function() {
  var self = this;
  self.conn = $.ajax({
        url: '{{ path('__procergsvpr_core_end_lc_query') }}',
        type: 'GET',
        dataType: 'json',
        success: function (data, textStatus, jqXHR) {
          self.user = data;
          self.refreshModel();
        },
        error: function (jqXHR, textStatus, errorThrown) {
        },
        complete: function (jqXHR, textStatus) {
            if (textStatus == 'abort') {

            } else if (jqXHR.status == 408) {
              self.poll();
          } else if (self.user.code == 0) {
            window.location.href = onSuccess;
            } else if (self.user.code == 1) {
              self.poll();
            } else if (self.user.code == 2) {
                setTimeout(self.poll(), 5000);
            }
        }
    });
}
userAction.refreshModel = function() {
  for (x in this.user.item) {
      //$('#req_'+x).prop('checked', this.user.item[x] ? true : false);
      if (this.user.item[x])
        $('#req_' + x + ' .glyphicon').addClass("glyphicon-ok");
      else
        $('#req_' + x + ' .glyphicon').addClass("glyphicon-remove");
  }

  if (this.user.code == 2)
    $('#req_tre_valid .glyphicon').addClass("glyphicon-ok");
  else
    $('#req_tre_valid .glyphicon').addClass("glyphicon-remove");
}

function go() {
  userAction.refreshModel();
  $("#lc-listener").modal("show");
}
$(function(){
  $("#lc-listener").on('shown.bs.modal', function (e) {
      userAction.poll();
    });
  $("#lc-listener").on('hidden.bs.modal', function (e) {
      userAction.conn.abort();
    });



})


</script>
{% endblock %}
